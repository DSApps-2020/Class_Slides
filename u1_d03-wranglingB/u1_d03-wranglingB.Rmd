---
title: "Tidy Data Wrangling - Part B"
subtitle: "Applications of Data Science"
author: "Giora Simchoni"
institute: "Stat. and OR Department, TAU"
date: "`r Sys.Date()`"
output_dir: "images"
output:
  xaringan::moon_reader:
    css: "../slides.css"
    seal: false
    chakra: "../libs/remark-latest.min.js"
    includes:
      in_header: "../header.html"
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
---

class: logo-slide

---

class: title-slide

## Tidy Data Wrangling - Part B

### Applications of Data Science - Class 3

### Giora Simchoni

#### `gsimchoni@gmail.com and add #dsapps in subject`

### Stat. and OR Department, TAU
### `r Sys.Date()`

---
```{r child = "../setup.Rmd"}
```

```{r packages, echo=FALSE, message=FALSE, warning=FALSE}
library(tidyverse)
```

class: section-slide

# Joining Tables

---
class: section-slide

# Detour: The Starwars Dataset(s)

---

## The Starwars Dataset(s)

<img src = "images/starwars_db_schema.png" style="width: 100%">

```{r Read-Starwars}
sw_tables <- read_rds("../data/sw_tables.rds")
characters <- sw_tables$characters
planets <- sw_tables$planets
films <- sw_tables$films
```

.insight[
`r emo::ji("bulb")` What are the advantages/disadvantages of storing data in such a way?
]
---

```{r Characters}
glimpse(characters)
```

---

```{r Planets}
glimpse(planets)
```

```{r Films}
glimpse(films)
```

---
class: section-slide

# End of Detour

---

#### Q: Which characters appear in SW films directed by George Lucas?

```{r BaseR-NoJoin, eval=FALSE}
unique(
  characters$name[
    characters$film_id %in%
      films$film_id[films$director == "George Lucas"]
    ]
  )

# or dplyr approach:
characters %>%
    filter(film_id %in% (films %>%
                           filter(director=="George Lucas") %>%
                           pull(film_id))) %>%
    pull(name) %>%
    unique()
```

First problem with this approach: code gets messier and messier, prone to bugs and hard to debug.
---

#### Q: Which characters, whose homeworld is Alderaan, appear in SW films directed by George Lucas?

```{r BaseR-NoJoin2, eval=FALSE}
unique(
  characters$name[
    characters$film_id %in%
      films$film_id[films$director == "George Lucas"] &
    characters$homeworld_id ==
      planets$planet_id[planets$name == "Alderaan"]
  ]
)

# or dplyr approach:
characters %>%
    filter(film_id %in% (films %>%
                           filter(director=="George Lucas") %>%
                           pull(film_id)),
           homeworld_id == (planets %>%
                              filter(name == "Alderaan") %>%
                              pull(planet_id))) %>%
    pull(name) %>%
    unique()

# [1] "Leia Organa"         "Bail Prestor Organa" "Raymus Antilles"
```

---

#### Now imagine these two tables

`lines`: each film, each scene, each minute, each character, the line

```{r SW-Lines}
lines <- tibble::tribble(
  ~film_id, ~scene_id, ~minute_id, ~character_id,                           ~line,
         1,         1,          1,            23,                "blah blah blah",
         1,         1,          2,            15,           "something something",
         1,         1,          2,            23, "something something to you to",
         1,         1,          3,            15,                              NA,
         1,         1,          3,            23,                              NA,
         1,         1,          4,             8,             "whatever whatever"
  )
```

`locations`: for each film, each scene, each minute, its location

```{r SW-Locations}
locations <- tibble::tribble(
  ~film_id, ~scene_id, ~minute_id,            ~location,
         1,         1,          1,          "spaceship",
         1,         1,          2, "Alderaan, outdoors",
         1,         1,          3,          "spaceship",
         1,         1,          4,                "bar"
  )
```

---

#### Q: Which characters say "something" in a bar?

- filter only `lines` which contain "something"
- filter only "bar" `locations` and then...
- if the two filtered tables match on film, scene and minute...
- we take the unique characters
- but how do we match? `for` loop*?

`r emo::ji("right arrow")` Clearly, second problem with this approach: it doesn't generalize well to more complex scenarios, where we need to match on multiple criteria

And third problem: speed .font80percent[(but only in a complex scenario!)]

.font80percent[&#42; There *is* a way without using a for loop, without joining, still not recommended.]

---

## `inner_join()`

(Inner) Joining two tables:

```{r Join-Two-Tables}
characters %>%
  inner_join(films) %>%
  select(character_id, name, film_id, title, director) %>%
  head(7)
```

---

(Inner) Joining multiple tables:

```{r Join-Three-Tables}
characters %>%
  inner_join(films) %>%
  inner_join(planets, by = c("homeworld_id" = "planet_id")) %>%
  select(character_id, name.x, film_id, title, director, name.y, climate) %>% head(7)
```

---

(Inner) Joining on multiple keys:

```{r Join-Multiple-Keys}
lines %>%
  inner_join(locations, by = c("film_id", "scene_id", "minute_id"))
```

.insight[
`r emo::ji("bulb")` The base R function for joining is `merge()` which tends to be slower.
]

---

## What would `inner_join()` do?

Q: Which characters appear in SW films directed by George Lucas?

```{r Join1, eval=FALSE}
# naive
characters %>%
  inner_join(films, by = "film_id") %>%
  filter(director == "George Lucas") %>%
  pull(name) %>%
  unique()

# smarter
characters %>%
  inner_join(films %>% filter(director == "George Lucas"),
             by = "film_id") %>%
  pull(name) %>%
  unique()
```

.insight[
`r emo::ji("bulb")` What else could you do to make `inner_join`'s life easier?
]
---

## What would `inner_join()` do?

Q: Which characters, whose homeworld is Alderaan, appear in SW films directed by George Lucas?

```{r Join2}
characters %>%
  inner_join(films %>% filter(director == "George Lucas"),
             by = "film_id") %>%
  inner_join(planets %>% filter(name == "Alderaan"),
             by = c("homeworld_id" = "planet_id"),
                    suffix = c("_char", "_planet")) %>%
  pull(name_char) %>%
  unique()
```

---

### Note of caution: Join is not always faster!

```{r Join-Slow}
baseR_no_join <- function() {
  unique(characters$name[characters$film_id %in% films$film_id[films$director == "George Lucas"]])
}

baseR_with_join <- function() {
  unique(merge(characters, films[films$director == "George Lucas", ], by = "film_id")$name)
}

dplyr_no_join <- function() {
  characters %>%
    filter(film_id %in% (films %>%
                           filter(director=="George Lucas") %>%
                           pull(film_id))) %>%
    pull(name) %>%
    unique()
}

dplyr_with_join <- function() {
  characters %>%
    inner_join(films %>% filter(director=="George Lucas"), by = "film_id") %>%
    pull(name) %>%
    unique()
}
```

---

```{r Join-Slow2, message=FALSE}
library(microbenchmark)
res <- microbenchmark(baseR_no_join(), baseR_with_join(),
                      dplyr_no_join(), dplyr_with_join(), times = 20)
autoplot(res)
```

---

### So when does it shine?

- See [this](https://stackoverflow.com/q/59183599/4095235) StackOverflow question and answer for a good example*
- But in general: when data gets bigger, when multiple keys are involved

.font80percent[&#42; Yes, I know, I answered my own question, `r emo::ji("person_facepalming")`]

### Other types of Joins?

Definitely, read [here](https://stat545.com/join-cheatsheet.html), [here](https://r4ds.had.co.nz/relational-data.html) and [here](https://rstudio-education.github.io/tidyverse-cookbook/transform-tables.html#joins) about:
- `left_join()`
- `right_join()`
- `full_join()`
- `anti_join()`
- `semi_join()`

---

## All Joins

<img src = "images/joins_explained1.png" style="width: 90%">

.font80percent[
Source: [The Tidyverse Cookbook](https://rstudio-education.github.io/tidyverse-cookbook/transform-tables.html#joins)
]
---

## All Joins

<img src = "images/joins_explained2.png" style="width: 90%">

.font80percent[
Source: [The Tidyverse Cookbook](https://rstudio-education.github.io/tidyverse-cookbook/transform-tables.html#joins)
]
---
class: section-slide

# Tidying Tables

---
class: section-slide

# Detour: The Migration Dataset

---

## The Migration Dataset

- Straight from the [UN, Dept. of Economic and Social Affairs, Population Division](https://www.un.org/en/development/desa/population/index.asp)
- "Monitoring global population trends"
- For each country, how many (men, women and total) migrated to each country
- In 1990, 1995, 2000, 2005, 2010, 2015, 2019
- How would *you* give access to these data?

---

### You want dirty data? Well dirty data costs!

<img src = "images/migration_excel.png" style="width: 100%">

---

### What's untidy about the migration Excel file?

- It's an Excel file `r emo::ji("angry")`
- Multiple sheets
- Color coded, font coded (bold), space coded!
- Logo, free text in header lines
- Merged cells
- French letters (anything but [A-Za-z] can break code)
- Spaces, parentheses in column names
- Different `NA` values: "..", "-"
- Variable "country_dest" contains sub-total and totals for categories, continents...
- Variable "country_orig" violates Tidy rule no. 1: not in its own column

---

### "Today Only, The Landlord Went Nuts!"

- ~~It's an Excel file `r emo::ji("angry")`~~
- ~~Multiple sheets~~
- ~~Color coded, font coded (bold), space coded!~~
- ~~Logo, free text in header lines~~
- ~~Merged cells~~
- ~~French letters (anything but [A-Za-z] can break code)~~
- ~~Spaces, parentheses in column names~~
- ~~Different `NA` values: "..", "-"~~
- ~~Variable "country_dest" contains sub-total and totals for categories, continents...~~
- Variable "country_orig" violates Tidy rule no. 1: not in its own column

---

## The much nicer `migration` table

```{r Migration1}
migration <- read_rds("../data/migration.rds")

migration
```

---

## It's not right, but it's Ok:

- How many men immigrated from Russia to Israel in 1990?

```{r Migration2}
migration %>%
  filter(country_dest == "israel", year == 1990, gender == "men") %>%
  pull(russian_federation)
```

- How many men immigrated from Israel to Russia in 1990?

```{r Migration3}
migration %>%
  filter(country_dest == "russian_federation", year == 1990, gender == "men") %>%
  pull(israel)
```

---

## It would have been much nicer to have:

```{r Migration4, eval=FALSE}
migration %>%
  filter(country_orig == "israel", country_dest == "russian_fedration",
         year == 1990, gender == "men") %>%
  pull(n_migrants)
```

Then we could put in a (simpler) function and call the opposite:

```{r Migration5, eval=FALSE}
get_1way_migration <- function(orig, dest, gen, .year) {
  migration %>%
  filter(country_orig == orig, country_dest == dest,
         year == .year, gender == gen) %>%
  pull(n_migrants)
}

get_1way_migration("russian_federation", "israel")
```

---

## `pivot_longer()`

```{r Pivot-Longer}
migration_long <- migration %>%
  pivot_longer(cols = -c(1:4),
               names_to = "country_orig",
               values_to = "n_migrants")

migration_long
```

---

## What sorcery is this?

<img src = "images/pivot_longer_explained.png" style="width: 100%">

.font80percent[Source: [The Carpentries](http://swcarpentry.github.io/r-novice-gapminder/14-tidyr/index.html)]

---

## `pivot_wider()`

```{r Pivot-Wider}
migration_wide <- migration_long %>%
  pivot_wider(id_cols = 1:4,
              names_from = country_orig,
              values_from = n_migrants)

migration_wide
```

---

### Where is this going to?
.font80percent[
```{r Where-Is-This-Going-To, eval=FALSE}
get_1way_migration <- function(.country_dest, .country_orig) {
  migration_long %>%
    filter(country_dest == .country_dest, country_orig == .country_orig) %>%
    group_by(year) %>%
    tally(n_migrants) %>%
    mutate(direction = str_c(.country_orig, " to ", .country_dest))
}
get_2way_migration <- function(country_a, country_b) {
  a2b <- get_1way_migration(country_b, country_a)
  b2a <- get_1way_migration(country_a, country_b)
  bind_rows(a2b, b2a)
}

get_2way_migration("israel", "russian_federation") %>%
  ggplot(aes(year, n)) + geom_line() +
  geom_point(color = "orange", size = 5) +
  labs(x = "", y = "", title = "Israel-Russia Yearly No. of immigrants") +
  theme_dark() +
  facet_wrap(~direction, scales = "free", labeller = labeller(direction = rus_isr_names)) +
  scale_y_continuous(labels = scales::comma_format()) +
  theme(axis.text = element_text(size = 12, hjust=0.9, family = "mono"),
        strip.text.x = element_text(size = 14, family = "mono"),
        plot.title = element_text(hjust = 0.5, size = 18, family = "mono"))
```
]

---

```{r Where-Is-This-Going-To2, echo=FALSE, fig.asp=0.62, out.width="100%"}
get_1way_migration <- function(.country_dest, .country_orig) {
  migration_long %>%
    filter(country_dest == .country_dest, country_orig == .country_orig) %>%
    group_by(year) %>%
    tally(n_migrants) %>%
    mutate(direction = str_c(.country_orig, " to ", .country_dest))
}

get_2way_migration <- function(country_a, country_b) {
  a2b <- get_1way_migration(country_b, country_a)
  b2a <- get_1way_migration(country_a, country_b)
  bind_rows(a2b, b2a)
}

rus_isr_names <- c(
  "israel to russian_federation" = "Israel to Russia",
  "russian_federation to israel" = "Russia to Israel"
)

get_2way_migration("israel", "russian_federation") %>%
  ggplot(aes(year, n)) +
  geom_line() +
  geom_point(color = "orange", size = 5) +
  labs(x = "", y = "", title = "Israel-Russia Yearly No. of immigrants") +
  theme_dark() +
  facet_wrap(~direction, scales = "free",
             labeller = labeller(direction = rus_isr_names)) +
  scale_y_continuous(labels = scales::comma_format()) +
  theme(axis.text = element_text(size = 12, hjust=0.9, family = "mono"),
        strip.text.x = element_text(size = 14, family = "mono"),
        plot.title = element_text(hjust = 0.5, size = 18, family = "mono"))
```

---

## Some more useful Tidying up verbs

Remember?

```{r Untidy-Okcupid}
table3 <- read_rds("../data/tidy_tables.rds")$table3

table3
```

---

## `separate()`

```{r Unite}
table3_tidy <- table3 %>%
  separate(pct_straight, into = c("straight", "total"), sep = "/")

table3_tidy
```

---

## `unite()`

(Though see a much more generalizable approach with `purrr`)

```{r Separate}
table3_tidy %>%
  unite(col = "pct_straight", straight, total, sep = "/")
```

---
class: section-slide

# Iteration: I don't `for`, I `purrr`

---
class: section-slide

# The Magic of List Columns

---